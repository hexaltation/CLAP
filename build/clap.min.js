/*! clap 2018-10-15 */

"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,i,t){return i&&_defineProperties(e.prototype,i),t&&_defineProperties(e,t),e}var Clap=function(){function r(e){var t=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"id",s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(_classCallCheck(this,r),this.width=120,this.height=120,this.background="#AAAAAA",this.margin=10,this.min=0,this.max=255,this.lineWidth=2,this.handlerSize=10,this.boundary=!1,this.boundaryColor="#FFFFFF",this.gradient=!1,this.selector_height=20,this.eye_size=8,this.colorOrder=["red","green","blue","alpha"],this.customisable=[{key:"width",type:"int"},{key:"height",type:"int"},{key:"background",type:"hexString"},{key:"margin",type:"int"},{key:"min",type:"int"},{key:"max",type:"int"},{key:"linewidth",type:"int"},{key:"handlerSize",type:"int"},{key:"boundary",type:"boolean"},{key:"boundaryColor",type:"hexString"},{key:"gradient",type:"boolean"}],s!={}&&this.initSettings(s),this.min>=this.max)throw new Error("min must be strictly inferior to max");if(this.colorLevels={red:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#FF0000",displayed:!0,active:!1,label:"red",mode:"screen"},green:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#00FF00",displayed:!0,active:!1,label:"green",mode:"screen"},blue:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#0000FF",displayed:!0,active:!1,label:"blue",mode:"screen"},alpha:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#FFFFFF",displayed:!0,active:!1,label:"alpha",mode:"multiply"}},!(e instanceof Element))throw new Error("First Parameter in Clap instanciation must be instance of Element");this.container=e,this.slider=document.createElement("canvas"),this.slider.id="color_level_"+i,this.container.appendChild(this.slider),this.event=new Event("clap_change",{bubbles:!0}),this.event.colorLevels=this.colorLevels,this.ctx=this.slider.getContext("2d"),this.draw(),this.slider.origin=this.slider.getBoundingClientRect(),this.clicked=!1,this.selectedVertice=null,this.slider.onmousedown=function(e){t.clicked=!0,t.isVerticeSelected(e),t.isSelectorClicked(e)},this.slider.onmouseup=function(){t.clicked=!1,t.selectedVertice=null},this.slider.onmousemove=function(e){if(t.clicked&&null!=t.active_layer&&null!=t.selectedVertice){var i=Math.floor((e.pageX-t.slider.origin.x-t.margin)*Math.abs(t.max-t.min)/(t.width-2*t.margin)+t.min);"min"===t.selectedVertice.key&&i>=t.selectedVertice.obj.max?t.selectedVertice.obj[t.selectedVertice.key]=t.selectedVertice.obj.max-1:"max"===t.selectedVertice.key&&i<=t.selectedVertice.obj.min?t.selectedVertice.obj[t.selectedVertice.key]=t.selectedVertice.obj.min+1:i<t.min?t.selectedVertice.obj[t.selectedVertice.key]=t.min:i>t.max?t.selectedVertice.obj[t.selectedVertice.key]=t.max:t.selectedVertice.obj[t.selectedVertice.key]=i,t.draw()}}}return _createClass(r,[{key:"initSettings",value:function(i){var t=this;if("object"!=_typeof(i))throw new Error("settings must be an object");this.customisable.forEach(function(e){i.hasOwnProperty(e.key)&&(t.typeChecking(i[e.key],e),t[e.key]=i[e.key])})}},{key:"typeChecking",value:function(e,i){if(_typeof(e)!==i.type&&"hexString"!==i.type&&"int"!==i.type)throw new TypeError(i.key+" must be of type "+i.type+". Here it's '"+_typeof(e)+"'.");if("number"==typeof e&&"int"===i.type&&!Number.isInteger(e))throw new TypeError(i.key+" must be of type "+i.type+". Here it's a vulgar 'number'.");if("string"==typeof e&&"hexString"===i.type&&!/^#[0-9A-F]{6}$/i.test(e))throw new TypeError(i.key+" must be of type "+i.type+". Here it's a vulgar 'string'.")}},{key:"draw",value:function(){var e=this.ctx;try{e.canvas.width=this.width,e.canvas.height=this.height+this.selector_height,this.draw_levels(),this.gradient&&(e.globalCompositeOperation="multiply",this.draw_gradient()),e.globalCompositeOperation="destination-over",this.boundary&&(e.strokeStyle=this.boundaryColor,e.strokeRect(this.margin,this.margin,this.width-2*this.margin,this.height-2*this.margin)),e.fillStyle=this.background,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.globalCompositeOperation="source-over",this.draw_selectors(),this.slider.dispatchEvent(this.event)}catch(e){console.log(e)}}},{key:"draw_levels",value:function(){var e=this.ctx;for(var i in this.colorLevels)this.colorLevels[i].displayed&&(e.globalCompositeOperation=this.colorLevels[i].mode,this.draw_level(this.colorLevels[i]))}},{key:"draw_level",value:function(e){this.ctx.fillStyle=e.color_value;var i=[e.in.min,e.in.max,e.out.max,e.out.min],t=this.draw_from_points(i);this.draw_vertices(e.color_value,t)}},{key:"draw_from_points",value:function(e){var i=this.ctx;i.beginPath();var t={nw:[(e[0]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,0+this.margin],ne:[(e[1]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,0+this.margin],se:[(e[2]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,this.height-this.margin],sw:[(e[3]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,this.height-this.margin]};return i.moveTo(t.nw[0],t.nw[1]),i.lineTo(t.ne[0],t.ne[1]),i.lineTo(t.se[0],t.se[1]),i.lineTo(t.sw[0],t.sw[1]),i.closePath(),i.fill(),t}},{key:"draw_vertices",value:function(e,i){for(var t in i)this.draw_vertex(e,i[t])}},{key:"draw_vertex",value:function(e,i){var t=this.ctx;t.lineWidth=this.lineWidth,t.strokeStyle=e,t.beginPath(),t.moveTo(i[0]-this.handlerSize/2,i[1]-this.handlerSize/2),t.lineTo(i[0]+this.handlerSize/2,i[1]-this.handlerSize/2),t.lineTo(i[0]+this.handlerSize/2,i[1]+this.handlerSize/2),t.lineTo(i[0]-this.handlerSize/2,i[1]+this.handlerSize/2),t.closePath(),t.stroke()}},{key:"draw_gradient",value:function(){var e=this.ctx,i=e.createLinearGradient(0,0,this.width,0);i.addColorStop(0,"black"),i.addColorStop(1,"white"),e.fillStyle=i;var t=this.get_externals_vertices();this.draw_from_points(t)}},{key:"get_externals_vertices",value:function(){var e,i,t,s;for(var r in this.colorLevels)(this.colorLevels[r].in.min<e||void 0===e)&&(e=this.colorLevels[r].in.min),(this.colorLevels[r].in.max>i||void 0===i)&&(i=this.colorLevels[r].in.max),(this.colorLevels[r].out.min<t||void 0===t)&&(t=this.colorLevels[r].out.min),(this.colorLevels[r].out.max>s||void 0===s)&&(s=this.colorLevels[r].out.max);return[e,i,s,t]}},{key:"draw_selectors",value:function(){var e=this.colorOrder;for(var i in e)this.draw_selector(e,i)}},{key:"draw_selector",value:function(e,i){this.draw_eye(e,i),this.draw_color_label(e,i)}},{key:"draw_eye",value:function(e,i){var t=this.ctx;t.lineWidth=1,t.fillStyle=this.colorLevels[e[i]].color_value,t.strokeStyle=this.colorLevels[e[i]].color_value,t.beginPath(),t.arc(30*i+this.eye_size,this.height+this.selector_height/2,this.eye_size,Math.PI/6,5*Math.PI/6,!1),t.arc(30*i+this.eye_size,this.height+this.selector_height/2+this.eye_size,this.eye_size,7*Math.PI/6,11*Math.PI/6,!1),t.stroke(),t.beginPath(),t.arc(30*i+this.eye_size,this.height+this.selector_height/2+this.eye_size/2,this.eye_size/2.5,0,2*Math.PI,!1),this.colorLevels[e[i]].displayed?t.fill():t.stroke()}},{key:"draw_color_label",value:function(e,i){var t=this.ctx;t.lineWidth=1,t.fillStyle=this.colorLevels[e[i]].color_value,t.strokeStyle=this.colorLevels[e[i]].color_value,t.font=String(2*this.eye_size)+"px Monospace";var s=this.colorLevels[e[i]].label.slice(0,1);this.colorLevels[e[i]].active&&(s=s.toUpperCase()),t.fillText(s,30*i+2*this.eye_size,this.height+this.selector_height*(2/3))}},{key:"selectActive",value:function(e){for(var i in this.colorLevels)this.colorLevels[i]===e&&0==this.colorLevels[i].active?(this.colorLevels[i].active=!0,this.active_layer=this.colorLevels[i]):this.colorLevels[i]===e&&1==this.colorLevels[i].active?(this.colorLevels[i].active=!1,this.active_layer=null):this.colorLevels[i].active=!1}},{key:"isVerticeSelected",value:function(e){if(null!=this.active_layer)for(var i=[{obj:this.active_layer.in,key:"min"},{obj:this.active_layer.in,key:"max"},{obj:this.active_layer.out,key:"min"},{obj:this.active_layer.out,key:"max"}],t=[[(this.active_layer.in.min-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,0+this.margin+this.slider.origin.y],[(this.active_layer.in.max-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,0+this.margin+this.slider.origin.y],[(this.active_layer.out.min-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,this.height-this.margin+this.slider.origin.y],[(this.active_layer.out.max-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,this.height-this.margin+this.slider.origin.y]],s=0;s<t.length;s++)if(t[s][0]-this.handlerSize/2<e.pageX&&e.pageX<t[s][0]+this.handlerSize/2&&t[s][1]-this.handlerSize/2<e.pageY&&e.pageY<t[s][1]+this.handlerSize/2){this.selectedVertice=i[s];break}}},{key:"isSelectorClicked",value:function(e){if(e.pageY-this.slider.origin.y>this.height)for(var i in this.colorOrder)30*Number(i)<e.pageX-this.slider.origin.x&&e.pageX-this.slider.origin.x<30*(Number(i)+1)&&(e.pageX-this.slider.origin.x<30*Number(i)+15?(this.colorLevels[this.colorOrder[i]].displayed=!this.colorLevels[this.colorOrder[i]].displayed,this.colorLevels[this.colorOrder[i]].displayed?this.colorLevels[this.colorOrder[i]].active:this.colorLevels[this.colorOrder[i]].active=!1):(this.selectActive(this.colorLevels[this.colorOrder[i]]),this.colorLevels[this.colorOrder[i]].active?this.colorLevels[this.colorOrder[i]].displayed=!0:this.colorLevels[this.colorOrder[i]].displayed));this.draw()}}]),r}();