/*! clap 2018-10-12 */

"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,i,t){return i&&_defineProperties(e.prototype,i),t&&_defineProperties(e,t),e}var Clap=function(){function n(e){var t=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"id",s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(_classCallCheck(this,n),this.width=120,this.height=120,this.background="#AAAAAA",this.margin=10,this.min=0,this.max=255,this.lineWidth=2,this.handlerSize=10,this.boundary=!1,this.boundaryColor="#FFFFFF",this.gradient=!1,this.customisable=[{key:"width",type:"int"},{key:"height",type:"int"},{key:"background",type:"hexString"},{key:"margin",type:"int"},{key:"min",type:"int"},{key:"max",type:"int"},{key:"linewidth",type:"int"},{key:"handlerSize",type:"int"},{key:"boundary",type:"boolean"},{key:"boundaryColor",type:"hexString"},{key:"gradient",type:"boolean"}],s!={}&&this.initSettings(s),this.min>=this.max)throw new Error("min must be strictly inferior to max");if(this.colorLevels={red:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#FF0000",displayed:!0,active:!1,label:"red",mode:"screen"},green:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#00FF00",displayed:!0,active:!1,label:"green",mode:"screen"},blue:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#0000FF",displayed:!0,active:!1,label:"blue",mode:"screen"},alpha:{in:{min:this.min,max:this.max},out:{min:this.min,max:this.max},color_value:"#FFFFFF",displayed:!0,active:!1,label:"alpha",mode:"multiply"}},!(e instanceof Element))throw new Error("First Parameter in Clap instanciation must be instance of Element");this.container=e,this.slider=document.createElement("canvas"),this.slider.id="color_level_"+i,this.container.appendChild(this.slider),this.event=new Event("clap_change",{bubbles:!0}),this.event.colorLevels=this.colorLevels,this.draw(this.slider),this.slider.origin=this.slider.getBoundingClientRect(),this.selector=document.createElement("div"),this.container.appendChild(this.selector),this.showHideBoxes(this.selector),this.clicked=!1,this.selectedVertice=null,this.slider.onmousedown=function(e){t.clicked=!0,t.isVerticeSelected(e)},this.slider.onmouseup=function(){t.clicked=!1,t.selectedVertice=null},this.slider.onmousemove=function(e){if(t.clicked&&null!=t.active_layer&&null!=t.selectedVertice){var i=Math.floor((e.pageX-t.slider.origin.x-t.margin)*Math.abs(t.max-t.min)/(t.width-2*t.margin)+t.min);"min"===t.selectedVertice.key&&i>=t.selectedVertice.obj.max?t.selectedVertice.obj[t.selectedVertice.key]=t.selectedVertice.obj.max-1:"max"===t.selectedVertice.key&&i<=t.selectedVertice.obj.min?t.selectedVertice.obj[t.selectedVertice.key]=t.selectedVertice.obj.min+1:i<t.min?t.selectedVertice.obj[t.selectedVertice.key]=t.min:i>t.max?t.selectedVertice.obj[t.selectedVertice.key]=t.max:t.selectedVertice.obj[t.selectedVertice.key]=i,t.draw(t.slider)}}}return _createClass(n,[{key:"initSettings",value:function(i){var t=this;if("object"!=_typeof(i))throw new Error("settings must be an object");this.customisable.forEach(function(e){i.hasOwnProperty(e.key)&&(t.typeChecking(i[e.key],e),t[e.key]=i[e.key])})}},{key:"typeChecking",value:function(e,i){if(_typeof(e)!==i.type&&"hexString"!==i.type&&"int"!==i.type)throw new TypeError(i.key+" must be of type "+i.type+". Here it's '"+_typeof(e)+"'.");if("number"==typeof e&&"int"===i.type&&!Number.isInteger(e))throw new TypeError(i.key+" must be of type "+i.type+". Here it's a vulgar 'number'.");if("string"==typeof e&&"hexString"===i.type&&!/^#[0-9A-F]{6}$/i.test(e))throw new TypeError(i.key+" must be of type "+i.type+". Here it's a vulgar 'string'.")}},{key:"draw",value:function(e){var i=e.getContext("2d");try{i.canvas.width=this.width,i.canvas.height=this.height,this.draw_levels(i),this.gradient&&(i.globalCompositeOperation="multiply",this.draw_gradient(i)),i.globalCompositeOperation="destination-over",this.boundary&&(i.strokeStyle=this.boundaryColor,i.strokeRect(this.margin,this.margin,this.width-2*this.margin,this.height-2*this.margin)),i.fillStyle=this.background,i.fillRect(0,0,i.canvas.width,i.canvas.height),e.dispatchEvent(this.event)}catch(e){console.log(e)}}},{key:"draw_levels",value:function(e){for(var i in this.colorLevels)this.colorLevels[i].displayed&&(e.globalCompositeOperation=this.colorLevels[i].mode,this.draw_level(e,this.colorLevels[i]))}},{key:"draw_level",value:function(e,i){e.fillStyle=i.color_value;var t=[i.in.min,i.in.max,i.out.max,i.out.min],s=this.draw_from_points(e,t);this.draw_vertices(e,i.color_value,s)}},{key:"draw_from_points",value:function(e,i){e.beginPath();var t={nw:[(i[0]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,0+this.margin],ne:[(i[1]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,0+this.margin],se:[(i[2]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,this.height-this.margin],sw:[(i[3]-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin,this.height-this.margin]};return e.moveTo(t.nw[0],t.nw[1]),e.lineTo(t.ne[0],t.ne[1]),e.lineTo(t.se[0],t.se[1]),e.lineTo(t.sw[0],t.sw[1]),e.closePath(),e.fill(),t}},{key:"draw_vertices",value:function(e,i,t){for(var s in t)this.draw_vertex(e,i,t[s])}},{key:"draw_vertex",value:function(e,i,t){e.lineWidth=this.lineWidth,e.strokeStyle=i,e.beginPath(),e.moveTo(t[0]-this.handlerSize/2,t[1]-this.handlerSize/2),e.lineTo(t[0]+this.handlerSize/2,t[1]-this.handlerSize/2),e.lineTo(t[0]+this.handlerSize/2,t[1]+this.handlerSize/2),e.lineTo(t[0]-this.handlerSize/2,t[1]+this.handlerSize/2),e.closePath(),e.stroke()}},{key:"draw_gradient",value:function(e){var i=e.createLinearGradient(0,0,this.width,0);i.addColorStop(0,"black"),i.addColorStop(1,"white"),e.fillStyle=i;var t=this.get_externals_vertices();this.draw_from_points(e,t)}},{key:"get_externals_vertices",value:function(){var e,i,t,s;for(var n in this.colorLevels)(this.colorLevels[n].in.min<e||void 0===e)&&(e=this.colorLevels[n].in.min),(this.colorLevels[n].in.max>i||void 0===i)&&(i=this.colorLevels[n].in.max),(this.colorLevels[n].out.min<t||void 0===t)&&(t=this.colorLevels[n].out.min),(this.colorLevels[n].out.max>s||void 0===s)&&(s=this.colorLevels[n].out.max);return[e,i,s,t]}},{key:"showHideBoxes",value:function(s){var n=this;s.innerHTML="";var e=function(e){var i=document.createElement("input"),t=document.createElement("label");i.type="checkbox",i.value=n.colorLevels[e].label,i.id="cb-"+n.colorLevels[e].label,n.colorLevels[e].displayed&&(i.checked=!0),i.addEventListener("change",function(e){var i=e.target.value;e.target.checked?n.colorLevels[i].displayed=!0:n.colorLevels[i].displayed=!1,n.draw(n.slider)}),t.for=i.id,t.innerHTML=n.colorLevels[e].label,n.colorLevels[e].active&&(t.style.textDecoration="underline"),t.ondblclick=function(){n.selectActive(n.colorLevels[e])},s.appendChild(i),s.appendChild(t)};for(var i in this.colorLevels)e(i);this.container.dispatchEvent(this.event)}},{key:"selectActive",value:function(e){for(var i in this.colorLevels)this.colorLevels[i]===e&&0==this.colorLevels[i].active?(this.colorLevels[i].active=!0,this.active_layer=this.colorLevels[i]):this.colorLevels[i]===e&&1==this.colorLevels[i].active?(this.colorLevels[i].active=!1,this.active_layer=null):this.colorLevels[i].active=!1;this.showHideBoxes(this.selector)}},{key:"isVerticeSelected",value:function(e){if(null!=this.active_layer)for(var i=[{obj:this.active_layer.in,key:"min"},{obj:this.active_layer.in,key:"max"},{obj:this.active_layer.out,key:"min"},{obj:this.active_layer.out,key:"max"}],t=[[(this.active_layer.in.min-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,0+this.margin+this.slider.origin.y],[(this.active_layer.in.max-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,0+this.margin+this.slider.origin.y],[(this.active_layer.out.min-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,this.height-this.margin+this.slider.origin.y],[(this.active_layer.out.max-this.min)*(this.width-2*this.margin)/Math.abs(this.max-this.min)+this.margin+this.slider.origin.x,this.height-this.margin+this.slider.origin.y]],s=0;s<t.length;s++)if(t[s][0]-this.handlerSize/2<e.pageX&&e.pageX<t[s][0]+this.handlerSize/2&&t[s][1]-this.handlerSize/2<e.pageY&&e.pageY<t[s][1]+this.handlerSize/2){this.selectedVertice=i[s];break}}}]),n}();